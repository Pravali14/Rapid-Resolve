<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapid Resolve App</title>
    <style>
        .hidden {
            display: none;
        }
        .container {
            margin: 20px;
        }
        button {
            margin: 5px;
        }
        #message {
            color: red;
        }
    </style>
</head>
<body>
    <h1>Welcome to Rapid Resolve</h1>
    <div id="message"></div>

    <!-- Initial Role Selection -->
    <div class="container" id="role-selection">
        <h2>Signup / Login</h2>
        <button onclick="showSignup()">Signup</button>
        <button onclick="showLogin()">Login</button>
    </div>

    <!-- Signup Form -->
    <div class="form-container hidden" id="signup">
        <h2>Signup</h2>
        <input type="text" id="signup-username" placeholder="Username" required>
        <input type="email" id="signup-email" placeholder="Email" required>
        <input type="text" id="signup-organization" placeholder="Organization" required>
        <input type="password" id="signup-password" placeholder="Password" required>
        <button onclick="signup()">Signup</button>
        <button onclick="showRoleSelection()">Back</button>
    </div>

    <!-- Login Form -->
    <div class="form-container hidden" id="login">
        <h2>Login</h2>
        <input type="text" id="login-username" placeholder="Username" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <button onclick="showRoleSelection()">Back</button>
    </div>

    <!-- User Dashboard -->
    <div class="container hidden" id="user-dashboard">
        <h2>User Dashboard</h2>
        <button onclick="showJoinTeam()">Join Team</button>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Team Leader Dashboard -->
    <div class="container hidden" id="team-leader-dashboard">
        <h2>Team Leader Dashboard</h2>
        <button onclick="showCreateTeam()">Create Team</button>
        <button onclick="showNotifications()">View Notifications</button>
        <button onclick="showHistory()">View History</button>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Create Team Form -->
    <div class="form-container hidden" id="create-team">
        <h2>Create Team</h2>
        <input type="text" id="team-code" placeholder="Team Code" required>
        <input type="password" id="team-password" placeholder="Team Password" required>
        <button onclick="createTeam()">Create Team</button>
        <button onclick="showTeamLeaderDashboard()">Back</button>
    </div>

    <!-- Join Team Form -->
    <div class="form-container hidden" id="join-team">
        <h2>Join Team</h2>
        <input type="text" id="join-team-code" placeholder="Team Code" required>
        <input type="password" id="join-team-password" placeholder="Team Password" required>
        <button onclick="requestJoinTeam()">Send Join Request</button>
        <button onclick="showUserDashboard()">Back</button>
    </div>

    <!-- Team Leader Notifications -->
    <div class="container hidden" id="team-leader-notifications">
        <h2>Team Leader Notifications</h2>
        <ul id="notifications-list"></ul>
        <button onclick="showTeamLeaderDashboard()">Back</button>
    </div>

    <!-- Team Leader History -->
    <div class="container hidden" id="team-leader-history">
        <h2>Team Leader History</h2>
        <ul id="history-list"></ul>
        <button onclick="showTeamLeaderDashboard()">Back</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            showRoleSelection();
        });

        function loadData() {
            const usersData = localStorage.getItem('users');
            const teamsData = localStorage.getItem('teams');
            const historyData = localStorage.getItem('history');
            const notificationsData = localStorage.getItem('notifications');

            window.users = usersData ? JSON.parse(usersData) : [];
            window.teams = teamsData ? JSON.parse(teamsData) : {};
            window.history = historyData ? JSON.parse(historyData) : {};
            window.notifications = notificationsData ? JSON.parse(notificationsData) : {};
        }

        function saveData() {
            localStorage.setItem('users', JSON.stringify(window.users));
            localStorage.setItem('teams', JSON.stringify(window.teams));
            localStorage.setItem('history', JSON.stringify(window.history));
            localStorage.setItem('notifications', JSON.stringify(window.notifications));
        }

        function showRoleSelection() {
            hideAll();
            document.getElementById('role-selection').classList.remove('hidden');
        }

        function showSignup() {
            hideAll();
            document.getElementById('signup').classList.remove('hidden');
        }

        function showLogin() {
            hideAll();
            document.getElementById('login').classList.remove('hidden');
        }

        function showUserDashboard() {
            hideAll();
            document.getElementById('user-dashboard').classList.remove('hidden');
        }

        function showTeamLeaderDashboard() {
            hideAll();
            document.getElementById('team-leader-dashboard').classList.remove('hidden');
        }

        function showCreateTeam() {
            hideAll();
            document.getElementById('create-team').classList.remove('hidden');
        }

        function showJoinTeam() {
            hideAll();
            document.getElementById('join-team').classList.remove('hidden');
        }

        function showNotifications() {
            hideAll();
            document.getElementById('team-leader-notifications').classList.remove('hidden');
            updateNotifications();
        }

        function showHistory() {
            hideAll();
            document.getElementById('team-leader-history').classList.remove('hidden');
            updateHistory();
        }

        function signup() {
            const username = document.getElementById('signup-username').value;
            const email = document.getElementById('signup-email').value;
            const organization = document.getElementById('signup-organization').value;
            const password = document.getElementById('signup-password').value;
            if (window.users.find(user => user.username === username || user.email === email)) {
                showMessage('Username or email already exists');
                return;
            }
            window.users.push({ username, email, organization, password, role: 'user', team: null });
            saveData();
            showMessage('User signed up successfully');
            showLogin();
        }

        function login() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const user = window.users.find(user => user.username === username && user.password === password);
            if (!user) {
                showMessage('Invalid username or password');
                return;
            }
            if (user.role === 'user') {
                showUserDashboard();
            } else if (user.role === 'team-leader') {
                showTeamLeaderDashboard();
            }
        }

        function createTeam() {
            const teamCode = document.getElementById('team-code').value;
            const teamPassword = document.getElementById('team-password').value;
            const leaderUsername = document.getElementById('login-username').value;
            const leader = window.users.find(user => user.username === leaderUsername && user.role === 'team-leader');
            if (window.teams[teamCode]) {
                showMessage('Team code already exists');
                return;
            }
            window.teams[teamCode] = { teamPassword, leader: leader.username, members: [], requests: [] };
            saveData();
            showMessage('Team created successfully');
            if (!window.history[leader.username]) {
                window.history[leader.username] = [];
            }
            window.history[leader.username].push(`Created team: ${teamCode}`);
            saveData();
            showTeamLeaderDashboard();
        }

        function requestJoinTeam() {
            const teamCode = document.getElementById('join-team-code').value;
            const teamPassword = document.getElementById('join-team-password').value;
            const team = window.teams[teamCode];
            if (!team || team.teamPassword !== teamPassword) {
                showMessage('Invalid team code or password');
                return;
            }
            const username = document.getElementById('login-username').value;
            const user = window.users.find(user => user.username === username);
            if (user.team) {
                showMessage('You are already in a team');
                return;
            }
            if (team.requests.includes(username)) {
                showMessage('Join request already sent');
                return;
            }
            team.requests.push(username);
            const leaderUsername = team.leader;
            if (!window.notifications[leaderUsername]) {
                window.notifications[leaderUsername] = [];
            }
            window.notifications[leaderUsername].push(`Join request from user ${username} for team ${teamCode}`);
            saveData();
            showMessage('Join request sent successfully');
            showUserDashboard();
        }

        function approveRequest(username, teamCode) {
            const team = window.teams[teamCode];
            if (!team || !team.requests.includes(username)) {
                showMessage('No join request found');
                return;
            }
            team.requests = team.requests.filter(request => request !== username);
            team.members.push(username);
            const user = window.users.find(user => user.username === username);
            if (user) {
                user.team = teamCode;
            }
            saveData();
            showMessage('Join request approved');
            if (!window.history[team.leader]) {
                window.history[team.leader] = [];
            }
            window.history[team.leader].push(`User ${username} joined team: ${teamCode}`);
            saveData();
            updateNotifications();
            showTeamLeaderDashboard();
        }

        function denyRequest(username, teamCode) {
            const team = window.teams[teamCode];
            if (!team || !team.requests.includes(username)) {
                showMessage('No join request found');
                return;
            }
            team.requests = team.requests.filter(request => request !== username);
            const leaderUsername = team.leader;
            if (!window.history[leaderUsername]) {
                window.history[leaderUsername] = [];
            }
            window.history[leaderUsername].push(`Join request from user ${username} denied for team: ${teamCode}`);
            saveData();
            showMessage('Join request denied');
            updateNotifications();
            showTeamLeaderDashboard();
        }

        function updateNotifications() {
            const leaderUsername = document.getElementById('login-username').value;
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            if (window.notifications[leaderUsername]) {
                window.notifications[leaderUsername].forEach(notification => {
                    const listItem = document.createElement('li');
                    listItem.textContent = notification;
                    const approveButton = document.createElement('button');
                    approveButton.textContent = 'Approve';
                    approveButton.onclick = () => {
                        const teamCode = notification.match(/team (\w+)/)[1];
                        approveRequest(notification.match(/user (\w+)/)[1], teamCode);
                    };
                    const denyButton = document.createElement('button');
                    denyButton.textContent = 'Deny';
                    denyButton.onclick = () => {
                        const teamCode = notification.match(/team (\w+)/)[1];
                        denyRequest(notification.match(/user (\w+)/)[1], teamCode);
                    };
                    listItem.appendChild(approveButton);
                    listItem.appendChild(denyButton);
                    notificationsList.appendChild(listItem);
                });
            }
        }

        function updateHistory() {
            const leaderUsername = document.getElementById('login-username').value;
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            if (window.history[leaderUsername]) {
                window.history[leaderUsername].forEach(entry => {
                    const listItem = document.createElement('li');
                    listItem.textContent = entry;
                    historyList.appendChild(listItem);
                });
            }
        }

        function logout() {
            showMessage('Logged out');
            showRoleSelection();
        }

        function hideAll() {
            document.querySelectorAll('.container, .form-container').forEach(element => {
                element.classList.add('hidden');
            });
        }

        function showMessage(message) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
